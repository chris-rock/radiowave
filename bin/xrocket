#!/usr/bin/env node
'use strict';

var winston = require('winston'),
    LogConfig = require('../config/LogConfig');

var logger = winston.loggers.get('xrocket');

// Xmpp Server
var XRocket = require('../core/XRocket'),
    Simple = require('../auth/Simple');

// initialize connection manager
var C2SServer = require('../net/C2SServer'),
    pem = require('pem');

// set log level
LogConfig.configure('silly');

// attach connection manager to xrocket
var xR = new XRocket();

// C2S Server 
var cs2 = null;
var tls = null;
pem.createCertificate({
    days: 1,
    selfSigned: true,
    organization : 'xrocket',
    organizationUnit : 'development',
    commonName : 'xrocket'

}, function (err, keys) {
    if (err) {
        logger.error(err);
    } else {
        tls = {
            key: keys.serviceKey + '\n',
            cert: keys.certificate + '\n'
        };
        tls.ca = tls.cert;

        cs2 = new C2SServer({
            port: 5222,
            domain: 'example.net',
            requestCert: true,
            rejectUnauthorized: false,
            tls: tls
        });
        xR.addConnectionManager(cs2);
    }
});
// register users
var simpleAuth = new Simple();
simpleAuth.addUser('romeo','romeo');
simpleAuth.addUser('mercutio','mercutio');
simpleAuth.addUser('benvolio','benvolio');
xR.connectionRouter.addAuthMethod(simpleAuth);

// base system is up and running
var ComponentRouter = require('../router/ComponentRouter');
var Rfc3921Roaster = require('../xep/Rfc3921-roaster');
var Rfc3921Messaging = require('../xep/Rfc3921-messaging');
var Xep0199 = require('../xep/Xep0199-ping');
var Xep0092 = require('../xep/Xep0092-version');
var Xep0030 = require('../xep/Xep0030-disco');
var Xep0060 = require('../xep/Xep0060-pubsub');

var cr = new ComponentRouter();

// start roaster
var PGConn = require('../util/PGConn');
var pgConnectionString = process.env.DATABASE_URL;
var pgC = new PGConn(pgConnectionString);
pgC.connect(function () {
    // roaster
    cr.register(new Rfc3921Roaster({
        storage: {
            client: pgC.getClient()
        }
    }));

    // pubsub
    cr.register(new Xep0060({
        subdomain: 'pubsub',
        domain: 'example.net',
        storage: {
            client: pgC.getClient()
        }
    }));
});

cr.register(new Rfc3921Messaging());
cr.register(new Xep0030());
cr.register(new Xep0199());
cr.register(new Xep0092());

var LogRouter = require('../router/LogRouter');
var lpr = new LogRouter();

// chain XRocket to Logger to ComponentRouter
xR.chain(lpr).chain(cr);

logger.debug('successfully started xrocket');